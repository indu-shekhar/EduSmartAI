{% extends "base.html" %}

{% block title %}Chat - EduSmartAI{% endblock %}

{% block content %}
<div class="row h-100">
    <!-- Sidebar (collapsible) -->
    <div class="col-md-3 bg-light border-end" id="sidebar">
        <div class="p-3">
            <h6 class="text-muted mb-3">Chat History</h6>
            <div id="conversationList">
                <!-- Conversation history will be loaded here -->
            </div>
            
            <hr>
            
            <div class="d-grid gap-2">
                <button class="btn btn-primary btn-sm" id="newChatBtn">
                    <i class="bi bi-plus-circle me-1"></i>New Chat
                </button>
                <button class="btn btn-outline-secondary btn-sm" id="clearHistoryBtn">
                    <i class="bi bi-trash me-1"></i>Clear History
                </button>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="col-md-9 d-flex flex-column" style="height: 100vh;">
        <!-- Chat Header -->
        <div class="bg-white border-bottom p-3">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-robot me-2"></i>
                    Educational Assistant
                </h5>
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#uploadModal">
                        <i class="bi bi-upload me-1"></i>Upload
                    </button>
                    <button class="btn btn-outline-info btn-sm" id="showStatsBtn">
                        <i class="bi bi-graph-up me-1"></i>Stats
                    </button>
                </div>
            </div>
        </div>

        <!-- Chat Messages -->
        <div class="flex-grow-1 overflow-auto p-3" id="chatMessages">
            <div class="welcome-message text-center text-muted py-5">
                <i class="bi bi-mortarboard-fill display-4 mb-3"></i>
                <h4>Welcome to EduSmartAI</h4>
                <p>Your intelligent educational assistant powered by RAG technology.</p>
                <p class="small">Ask questions about your study materials, request summaries, or compare concepts.</p>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="bg-white border-top p-3">
            <form id="chatForm" class="d-flex gap-2">
                <div class="flex-grow-1">
                    <div class="input-group">
                        <textarea 
                            class="form-control" 
                            id="messageInput" 
                            placeholder="Ask a question about your study materials..."
                            rows="1"
                            style="resize: none;"
                        ></textarea>
                        <button class="btn btn-outline-secondary" type="button" id="attachBtn" title="Attach file">
                            <i class="bi bi-paperclip"></i>
                        </button>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" id="sendBtn">
                    <i class="bi bi-send-fill"></i>
                </button>
            </form>
            
            <!-- Quick Actions -->
            <div class="mt-2">
                <small class="text-muted me-2">Quick actions:</small>
                <button class="btn btn-link btn-sm p-0 me-2" onclick="insertText('Summarize ')">
                    üìÑ Summary
                </button>
                <button class="btn btn-link btn-sm p-0 me-2" onclick="insertText('Compare ')">
                    ‚öñÔ∏è Compare
                </button>
                <button class="btn btn-link btn-sm p-0" onclick="insertText('Explain ')">
                    üí° Explain
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Documents</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="fileInput" class="form-label">Select files (PDF, DOC, TXT)</label>
                        <input type="file" class="form-control" id="fileInput" multiple 
                               accept=".pdf,.doc,.docx,.txt">
                        <div class="form-text">Maximum file size: 20MB per file</div>
                    </div>
                    
                    <div id="uploadProgress" class="d-none">
                        <div class="progress mb-2">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted">Uploading...</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="uploadBtn">Upload</button>
            </div>
        </div>
    </div>
</div>

<!-- Citations Modal -->
<div class="modal fade" id="citationsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sources & Citations</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="citationsContent">
                    <!-- Citations will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stats Modal -->
<div class="modal fade" id="statsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Session Statistics</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="statsContent">
                    <!-- Stats will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // Initialize chat functionality
    const sessionId = '{{ session_id }}';
    
    // Auto-resize textarea
    document.getElementById('messageInput').addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    
    // Handle Enter key (Shift+Enter for new line)
    document.getElementById('messageInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.getElementById('chatForm').dispatchEvent(new Event('submit'));
        }
    });
    
    // Insert text helper
    function insertText(text) {
        const input = document.getElementById('messageInput');
        input.value = text;
        input.focus();
    }
</script>
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
{% endblock %}
